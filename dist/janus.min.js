var Janus=Janus||{};Janus.Connection=function(a){if(this.server=a.server,this.session=a.session,this.options={},this.ws=null,this.connected=!1,_.defaults(a,{success:_.noop,error:_.noop}),0===this.server.lastIndexOf("http://",0))this.options=_.defaults(_.pick(a),{pollTimeout:6e4,pollFrequency:500,maxPollSize:1,maxPollRetries:3}),this._send=_.bind(this._httpSend,this),this._close=_.bind(this._httpClose,this),this._httpSetup(a);else{if(0!==this.server.lastIndexOf("ws://",0)&&0!==this.server.lastIndexOf("wss://",0))throw"Server '"+this.server+"' has unsupported scheme.";this.options=_.defaults(_.pick(a),{keepAliveFrequency:3e4}),this._send=_.bind(this._wsSend,this),this._close=_.bind(this._wsClose,this),this._wsSetup(a)}},_.extend(Janus.Connection,Backbone.Events),Janus.Connection.prototype.send=function(a,b){var c=Q.defer();return _.defaults(a,{transaction:this.session.generateTransactionId(),apisecret:this.session.secret}),b=b||{},_.extend(b,{success:function(a){c.resolve(a)},error:function(a){c.reject(a)}}),this._send(a,b),c.promise},Janus.Connection.prototype.close=function(a){var b=Q.defer();return a=a||{},_.extend(a,{success:function(){b.resolve()},error:function(a){b.reject(a)}}),this._close(a),b.promise},Janus.Connection.prototype._httpSetup=function(a){var b=this,c={janus:"create",transaction:this.session.generateTransactionId(),apisecret:this.session.secret};return a=a||{},$.ajax({type:"POST",url:this.server+"/janus",async:!0,cache:!1,contentType:"application/json",data:JSON.stringify(c),dataType:"json",success:function(c){b.connected=!0,a.success(c.data),b._httpPoll()},error:function(c,d,e){var f=d+" - "+e;b.connected=!1,a.error(f)}})},Janus.Connection.prototype._httpPoll=function(a){if(this.connected){var b=this,c={apisecret:this.session.secret},d={rid:(new Date).getTime()};return this.options.maxPolled&&(d.maxev=this.options.maxPolled),a=a||0,$.ajax({type:"GET",url:this.session.url(d),data:JSON.stringify(c),dataType:"json",cache:!1,timeout:this.options.pollTimeout,success:function(a){b.connected&&setTimeout(_.bind(b._httpPoll,b,0),b.options.pollFrequency),b.session.handleEvent(a)},error:function(c){return a++,a<b.options.maxPollRetries?void setTimeout(_.bind(b._httpPoll,b,a),b.options.pollFrequency):void(b.connected&&(0===c.status?b.session.trigger("janus:error","connection","Could not connect to the gateway "+a+"x. Is it down?"):b.session.trigger("janus:error","connection","Gateway rejected connnection "+a+"x. Try reconnecting."),b.session.handleDisconnect()))}})}},Janus.Connection.prototype._httpSend=function(a,b){var c=this,d=b.plugin?b.plugin.url():this.session.url();return _.defaults(b,{sync:!1,type:"POST"}),b.success&&(c.session.transactions[a.transaction]=b.success),$.ajax({type:b.type,url:d,async:!b.sync,cache:!1,contentType:"application/json",data:JSON.stringify(a),dataType:"json",success:function(a){c.session.handleEvent(a)},error:function(d,e,f){if(a.transaction in c.session.transactions&&delete c.session.transactions[a.transaction],b.error){var g=e+" - "+f;b.error(g)}}})},Janus.Connection.prototype._httpClose=function(a){var b={janus:"destroy"};return this.connected=!1,this.send(b,a)},Janus.Connection.prototype._wsSetup=function(a){var b=this,c=new WebSocket(this.server,"janus-protocol");c.onclose=function(){b.connected=!1,b.session.cxn===b&&b.session.handleDisconnect(),b._ws&&(b._ws.close(),b._ws=null)},c.onerror=function(){},c.onmessage=function(a){var c=JSON.parse(a.data);b.session.handleEvent(c)},c.onopen=function(){b.connected=!0,b._wsKeepAlive(),b.send({janus:"create"}).then(function(b){a.success(b)})},this._ws=c},Janus.Connection.prototype._wsSend=function(a,b){return b.success&&(this.session.transactions[a.transaction]=b.success),this.session.get("id")&&(a.session_id=this.session.get("id")),b.plugin&&b.plugin.get("id")&&(a.handle_id=b.plugin.get("id")),console.log(a),this._ws.send(JSON.stringify(a))},Janus.Connection.prototype._wsKeepAlive=function(){return this.connected?(this.session.get("id")&&this.send({janus:"keepalive"}),void setTimeout(_.bind(this._wsKeepAlive,this),this.options.keepAliveFrequency)):void console.info("exiting keep-alive loop")},Janus.Connection.prototype._wsClose=function(a){this._ws&&(this._ws.close(),this._ws=null),this.connected=!1,_.defer(a.success)},Janus.Plugin=Backbone.Model.extend({defaults:{id:null,sdp:null,sdpSent:!1,pc:null,dataChannel:null,iceTrickle:!0,iceDone:!1,localStream:null,media:{audioRecv:!1,audioSend:!1,videoRecv:!1,videoSend:!1,data:!1}},url:function(){return this.session.url()+"/"+this.get("id")},isAttached:function(){return void 0!==this.session&&null!==this.session&&null!==this.get("id")},attach:function(a){var b=this,c={janus:"attach",plugin:this.get("name")};return a.cxn.send(c).then(function(c){return b.session=a,b.set("id",c.id),console.info("attached plugin '"+b.get("id")+"' to session '"+b.session.get("id")+"'"),b.session.plugins[b.get("id")]=b,b.trigger("janus:attach"),b.session.trigger("janus:attach",b),Q.fcall(function(){return c})},function(a){b.session=null,b.session.trigger("janus:error","attach",a)})},detach:function(){if(!this.isAttached()){var a=Q.defer();return _.defer(function(){b.handleDetach(),a.resolve()}),a.promise}var b=this;return session.cxn.send(req).then(function(a){return console.info("janus-detach: ",a),b.handleDetach(),Q.fcall(function(){return a})},function(a){console.error("janus-detach failed:",a),b.handleDetach()})},handleDetach:function(){var a=this.session;void 0!==a&&null!==a&&(this.get("id")in a.plugins&&delete a.plugins[this.get("id")],this.trigger("janus:detach"),a.trigger("janus:detach",this),this.session=null),this.set("id",null),this.hangupPeerConnection()},getUserMedia:function(){function a(a){console.info("webrtc: getUserMedia",a),c.set("localStream",a),c.trigger("webrtc:localstream",a),d.resolve(a)}function b(a){console.error("webrtc: getUserMedia failed",b),d.reject(a)}var c=this,d=Q.defer();return MediaStreamTrack.getSources(function(d){var e=d.some(function(a){return"audio"===a.kind}),f=d.some(function(a){return"video"===a.kind}),g={audio:e&&c.isAudioSendEnabled(),video:f&&c.isVideoSendEnabled()};getUserMedia(g,a,b)}),d.promise},createPeerConnection:function(a){a=a||{};var b=this,c=Q.defer();if(!this.get("localStream")&&(this.isAudioSendEnabled()||this.isVideoSendEnabled()))return this.getUserMedia().then(function(){return b.createPeerConnection(a)},function(a){c.reject(a)}).then(function(a){c.resolve(a)},function(a){c.reject(a)});var d=new RTCPeerConnection({iceServers:this.session.iceServers},this.session.pcConstraints);if(this.set("pc",d),this.get("localStream")&&(console.info("webrtc: local stream",this.get("localStream")),d.addStream(this.get("localStream"))),d.onaddstream=function(a){console.debug("webrtc: remote stream",a),b.trigger("webrtc:remotestream",a)},this.isDataEnabled()){var e=d.createDataChannel("janus",{ordered:!1});e.onmessage=function(a){b.trigger("webrtc:datachannel:message",a.data)},e.onopen=function(){b.trigger("webrtc:datachannel:opened")},e.onclose=function(a){b.trigger("webrtc:datachannel:closed",a.data)},e.onerror=function(a){b.trigger("webrtc:datachannel:error",a)},this.set("dataChannel",e)}return d.ondatachannel=function(a){console.debug("webrtc: remote data channel",a),b.trigger("webrtc:datachannel",a)},d.onicecandidate=function(a){if(a.candidate){console.debug("webrtc: local ice candidate",a);var c={candidate:a.candidate.candidate,sdpMid:a.candidate.sdpMid,sdpMLineIndex:a.candidate.sdpMLineIndex};return b.sendIceCandidate(c),void b.trigger("webrtc:icecandidate",a)}console.debug("webrtc: all local ice candidates have been generated"),b.set("iceDone",!0),b.get("iceTrickle")?b.sendIceCandidate({completed:!0}):b.trigger("webrtc:icecomplete")},_.defer(function(){c.resolve(d)}),c.promise},hangupPeerConnection:function(){this.get("localStream")&&(console.debug("webrtc: stopping local stream"),this.get("localStream").stop()),this.get("pc")&&(console.debug("webrtc: closing peer connection"),this.get("pc").close()),console.debug("webrtc: resetting state"),this.set("sdp",null),this.set("sdpSent",!1),this.set("pc",null),this.set("dataChannel",null),this.set("iceDone",!1),this.set("localStream",null),this.trigger("webrtc:hangup")},hasDataChannel:function(){return null!==this.get("dataChannel")},sendData:function(a){console.debug("sending data through channel '"+this.get("dataChannel").label+"': ",a),this.get("dataChannel").send(a)},sendMessage:function(a,b){var c=this,d=Q.defer(),e={janus:"message",body:a};return b=b||{},_.defaults(b,{plugin:this}),null!==b.jsep&&void 0!==b.jsep?e.jsep=b.jsep:this.get("sdp")&&!this.get("sdpSent")&&(e.jsep=this.get("sdp")),this.session.cxn.send(e,b).then(function(a){e.jsep&&c.set("sdpSent",!0),d.resolve(a)},function(a){d.reject(a)}),d.promise},sendIceCandidate:function(a,b){var c=Q.defer(),d={janus:"trickle",candidate:null!==a?a:{completed:!0}};return b=b||{},_.defaults(b,{plugin:this}),this.session.cxn.send(d,b),c.promise},createOffer:function(){function a(a){console.log("webrtc: created offer",a),(null===c.get("sdp")||void 0===c.get("sdp"))&&(console.log("webrtc: set local description",a),c.set("sdp",{type:"offer",sdp:a.sdp}),c.get("pc").setLocalDescription(a)),c.trigger("webrtc:offer",a),d.resolve(a)}function b(a){console.log("webrtc: failed to create offer",a),d.reject(a)}var c=this,d=Q.defer(),e={mandatory:{OfferToReceiveAudio:this.isAudioRecvEnabled(),OfferToReceiveVideo:this.isVideoRecvEnabled()}};return console.log("webrtc: create offer",e),this.get("pc").createOffer(a,b,e),d.promise},createAnswer:function(){function a(a){console.log("webrtc: created answer",a),(null===c.get("sdp")||void 0===c.get("sdp"))&&(console.log("webrtc: set local description to",a),c.set("sdp",{type:"answer",sdp:a.sdp}),c.get("pc").setLocalDescription(a)),c.trigger("webrtc:answer",a),d.resolve(a)}function b(a){console.log("webrtc: failed to create answer",a),d.reject(a)}var c=this,d=Q.defer();return mediaConstraints={mandatory:{OfferToReceiveAudio:this.isAudioRecvEnabled(),OfferToReceiveVideo:this.isVideoRecvEnabled()}},console.log("webrtc: create answer",mediaConstraints),this.get("pc").createAnswer(a,b,mediaConstraints),d.promise},handleEvent:function(a,b){var c=this;b&&(this.get("pc")?this.setRemoteDescription(b):this.createPeerConnection().then(function(){c.setRemoteDescription(b)})),this.trigger("janus:event",a,b)},setRemoteDescription:function(a){function b(){console.log("webrtc: accepted remote description",a),"offer"==a.type&&d.createAnswer(),e.resolve(a)}function c(a){console.log("webrtc: rejected remote description",a),e.reject(a)}var d=this,e=Q.defer();return a instanceof RTCSessionDescription||(a=new RTCSessionDescription(a)),console.log("webrtc: setting remote description",a),this.get("pc").setRemoteDescription(a,b,c),e.promise},isAudioSendEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.audio===!1?!1:void 0===a.audioSend||null===a.audioSend?!0:a.audioSend===!0},isAudioRecvEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.audio===!1?!1:void 0===a.audioRecv||null===a.audioRecv?!0:a.audioRecv===!0},isVideoSendEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.video===!1?!1:void 0===a.videoSend||null===a.videoSend?!0:a.videoSend===!0},isVideoRecvEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.video===!1?!1:void 0===a.videoRecv||null===a.videoRecv?!0:a.videoRecv===!0},isDataEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.data===!0},attached:function(){function a(){b.off(null,a),c.resolve()}var b=this,c=Q.defer();return _.defer(function(){return b.isAttached()?void a():void b.once("janus:attach",a)}),c.promise},negotiated:function(){function a(){b.off(null,a),c.resolve()}var b=this,c=Q.defer();return _.defer(function(){return b.get("sdp")?void a():(b.once("webrtc:offer",a),void b.once("webrtc:answer",a))}),c.promise}}),Janus.Session=Backbone.Model.extend({defaults:{id:null},initialize:function(a,b){this.cxnConfig={server:b.urlRoot},this.cxn=null,this.secret=b.secret,this.transactions={},this.plugins={},this.iceServers=b.iceServers||[],this.pcConstraints=b.pcConstraints||null},url:function(a){return this.cxnConfig.server+"/janus/"+this.get("id")+(a?"?"+$.param(a):"")},connect:function(a){function b(a){console.log("create session",a),d.cxn=e,d.set("id",a.id),console.log("created session w/ id "+d.get("id")),d.trigger("janus:connect"),f.resolve(e)}function c(){console.error("create session",reason),d.cxn=null,d.trigger("janus:error","connect",reason),f.reject(reason)}var d=this,e=null,f=Q.defer();return a=a||{},_.extend(a,this.cxnConfig),_.extend(a,{session:this,success:b,error:c}),this.isConnected()?_.defer(function(){f.resolve()}):e=new Janus.Connection(a),f.promise},isConnected:function(){return null!==this.cxn},disconnect:function(){var a,b=this;if(this.isConnected())a=this.cxn.close();else{var c=Q.defer();_.defer(function(){c.resolve()}),a=c.promise}return a.then(function(){b.handleDisconnect()},function(){b.handleDisconnect()}),a},reconnect:function(a){var b=this;return a=_.extend(a||{},this.cxnConfig),this.disconnect().then(function(){return b.connect(a)},function(){return b.connect(a)})},generateTransactionId:function(){return _.sample("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",12).join("")},handleDisconnect:function(){var a=this.get("id");this.cxn=null,this.set("id",null),_.each(_.values(this.plugins),function(a){a.handleDetach()}),this.plugins={},this.transactions={},this.trigger("janus:disconnect",a)},handleEvent:function(a){function b(a){if(a in g.transactions){var b=g.transactions[a];return delete g.transactions[a],b}return _.noop}if(_.isArray(a))return void _.each(a,this.handleEvent);console.log("event for session "+this.get("id"),a);var c,d,e,f,g=this,h=a.sender,i=a.jsep;switch(a.janus){case"success":d=a.plugindata,void 0===d||null===d?b(a.transaction)(a.data):(console.info("event from "+h+" ("+d.plugin+")"),b(a.transaction)(d.data));break;case"error":f="error"in a?a.error:a,console.error("oops: "+f.code+" "+f.reason),b(a.transaction)(f);break;case"keepalive":break;case"ack":break;case"webrtcup":break;case"hangup":if(c=this.plugins[h],void 0===c||null===c){console.info("no plugin for sender '"+h+"'");break}c.detach();break;case"detached":if(c=this.plugins[h],void 0===c||null===c){console.info("no plugin for sender '"+h+"'");break}c.detach();break;case"event":if(void 0===h||null===h){console.warn("missing sender");break}if(d=a.plugindata,void 0===d||null===d)return void console.warn("missing plugindata");if(console.info("event from "+h+" ("+d.plugin+")"),e=d.data,c=this.plugins[h],void 0===c||null===c){console.info("no plugin for sender '"+h+"'");break}void 0!==i&&null!==i&&console.info("... and it came w/ SDP",i),c.handleEvent(e,i),b(a.transaction)(e,i);break;default:console.warn("unknown event '"+a.janus+"', ignoring ...")}},findPlugin:function(a){var b=_.findKey(this.plugins,a);return void 0!==b?this.plugins[b]:void 0}});